#!/bin/bash

# usage: 
#
# $ export X509_USER_PROXY=/trusted/peer/credentials
# $ /where/it/is/jpps_store_test \
#	-s jppps.host.name:port	\	# default localhost:8901
#	-o '/job/owner/DN' \		# mandatory
#	-t "name=value" ... \ 		# may occur multiple times
#	-d /dump/file/template			# optional
#
# in /dump/file/template occurences of _CHANGE_ME_JOBID_ are substituted with
# fake jobid generated by this script

echodo()
{
	echo '**' $@
	"$@" || exit 1
}

jpps="./jpps-test"

#getopt -s sh o:d:t:s: "$@"
#set -- `getopt -s sh o:d:t:s: "$@"`
while [ "x$1" != x ]; do case $1 in
	-s) shift; jpps="$jpps -s $1";;
	-o) shift; owner="$1";;
	-d) shift; dump="$1";;
	-t) shift; tags="$1|$tags";;
esac; shift; done

[ x"$owner" = x ] && { echo -o required; exit 1; }

jobid="https://nonexistent.test.server/jpps_store_test_$$"

echodo $jpps RegisterJob $jobid "$owner"

echodo $jpps GetJobAttr $jobid http://egee.cesnet.cz/en/Schema/JP/System:owner

echodo $jpps GetJobAttr $jobid http://egee.cesnet.cz/en/Schema/JP/System:regtime


if [ -f "$dump" ]; then
	sed "s/_CHANGE_ME_JOBID_/$jobid/" $dump >job.$$
	echodo $jpps StartUpload $jobid urn:org.glite.jp.primary:lb 1234 text/plain >start.$$
	cat start.$$
	dest=`grep '^Destination:' start.$$ | cut -d' ' -f2`
	rm start.$$
	echodo globus-url-copy "file:$PWD/job.$$" $dest 
	rm job.$$
	echodo $jpps CommitUpload "$dest"

# does not pass authz check -- probably OK
#	echodo $jpps GetJobFiles $jobid
fi

if [ "x$tags" != x ]; then
	oIFS=$IFS
	IFS='|'
	set -- $tags
	IFS=$oIFS

	while [ x$1 != x ]; do
		value=`echo $1 | sed 's/^.*=//'`
		name=`echo $1 | sed 's/=.*$//'`

		echodo $jpps RecordTag $jobid $name $value

		echodo $jpps GetJobAttr $jobid $name

		shift
	done
fi
