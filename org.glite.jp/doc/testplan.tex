\documentclass{egee}
\usepackage{comment,alltt}

\def\LB{L\&B}

\title{Job Provenance Test Plan}
\author{CESNET EGEE JRA1 team}
\DocIdentifier{EGEE-JRA1-??}
\Date{\today}
\Activity{JRA1: Middleware Engineering and Integration}
\DocStatus{DRAFT}
\Dissemination{PUBLIC}
\DocumentLink{}

\def\req{\noindent\textbf{Prerequisities:}}
\def\how{\noindent\textbf{How to run:}}
\def\result{\noindent\textbf{Expected result:}}

\def\path#1{{\normalfont\textsf{#1}}}
\def\code#1{\texttt{#1}}

\def\todo#1{\textbf{TODO:} #1}


\specialcomment{hints}{\par\noindent\textbf{Hints: }\begingroup\slshape}{\endgroup}
%\includecomment{hints}

\begin{document}

\input{frontmatter}
\newpage
\tableofcontents
\newpage

\section{Rationale}
\subsection{Glossary}
\begin{itemize}
\item JP -- Job Provenance
\item JPPS -- Job Provenance Primary Storage
\item JPPSBE -- Job Provenance Primary Storage Back-end
\item JPIS -- Job Provenance Index Server
\end{itemize}

\todo{}

\section{Test Coverage}
\todo{}

%\chapter{Test Cases}

\section{JPPS standalone tests}

\subsection{Job registration}

\subsubsection{Basic functionality}
- call RegisterJob
* call GetJobAttributes owner to verify

\subsubsection{AuthZ check}
* call GetJobAttributes with different credentials - should fail

\subsection{Tag recording}
- call RecordTag
* call GetJobAttributes to verify
- record and retrieve more values of the same tag

\subsection{File upload}

\subsubsection{Basic functionality}
- call StartUpload, LB dump file type
* check with GetJobFiles -- shoud return nothing
- upload via ftp
- call CommitUpload
* check with GetJobFiles -- should return URL
- retrieve and check the file

\subsubsection{AuthZ checks}
(should fail)
* call GetJobFiles with different credentials

* StartUpload with different credentials

- StartUpload
* ftp upload with different credentials

* ftp GET with different credentials

\subsubsection{Cleanup}
(Foreseen test for feature which is not implemented yet)
- call StartUpload, short timeout
- upload via ftp
(don't call CommitUpload)
* uploaded file should be purged after timeout

\section{LB plugin}
\todo{TBD}

\section{JPPS-JPIS interaction (feeds)}

\todo{import this chapter from testplan.txt}

%set of queries (how many?) with different "triggering conditions":
%- on job registration
%- on LB file upload
%- on RecordTag

%corresponding sets of jobs to each query, each containing jobs which match
%and which don't

%- initial IS release -- single query, so just one set of jobs
%- due to 3.2 no point in pre-loading PS database, use 1.3.1

\subsection{Single batch feed}
%- upload jobs to PS
%- start feed
%* check IS contents (jobs and expected attr values)

\req\ Clean JP-PS and JP-IS database.

\how\
\begin{enumerate}
 \item \emph{Start JP primary server}
 \item \emph{Register job to PS}
  \begin{alltt}
    jpps_store_test -o \emph{CERT_DN} -t "my_tag=car" -s https://localhost:8901  
  \end{alltt}
  You should see something like:
  \begin{alltt}
    ** ./jpps-test -s https://localhost:8901 RegisterJob
    https://nonexistent.test.server/jpps_store_test_7199
           /O=CESNET/O=Masaryk University/CN=Milos Mulac
    OK
    ** ./jpps-test -s https://localhost:8901 GetJobAttr
    https://nonexistent.test.server/jpps_store_test_7199
           http://egee.cesnet.cz/en/Schema/JP/System:owner
    OK
    Attribute values: /O=CESNET/O=Masaryk University/CN=Milos Mulac
           SYSTEM  Thu Feb 16 14:40:02 2006
    ....
    Attribute values:
           car     FILE    Thu Feb 16 14:40:02 2006
  \end{alltt}
 \item \emph{Start JP index server, using history query}\\
  \begin{alltt}
  ./glite-jp-indexd -s https://localhost:8901 -d -n -q hist 
  \end{alltt}
 \item \emph{Check content of IS database}\\
  \begin{alltt}
   mysql -u jpis -e "select * from jobs;" jpis1
  \end{alltt}
 You should get some result, similar to:
  \begin{alltt}
| jobid                            | dg_jobid | 
ownerid                            | aclid | ps                     |
+------------------------------------------------------------------------+
| 92eb48c03929587f793e97f895ac958b |https://nonexistent.test.server/jpps_store_test_1273 
| 5864429d57da18e4ecf9ea366c6b2c9c | NULL  | https://localhost:8950 |
  \end{alltt}
\end{enumerate}
\result{} Expected results in the IS database content check (last step).



\subsection{single incremental feed}
%- register feed
%- upload jobs to PS one by one
%* check IS contents (matching jobs should turn up, others not)

\req\ Clean JP-PS and JP-IS database.

\how\
\begin{enumerate}
 \item \emph{Start JP primary server}
 \item \emph{Start JP index server, using continuous query}
  \begin{alltt}
   ./glite-jp-indexd -s https://localhost:8901 -d -n -q cont
  \end{alltt}
 \item \emph{Register job to PS}
  The same as in previous test case.

 \item \emph{Check output of IS}\\
  You should see incomming connection logs, and among them
  several times something like:
  \begin{alltt}
    
   INSERT INTO attr_52942b8c70bab8491ab5d3b9713d79f5 (jobid, value,
                                        full_value, origin) VALUES (
     '6f4866f3e4f8204c269449e6924d73c0',
     'S:/O=CESNET/O=Masaryk University/CN=Milos Mulac',
     'S:/O=CESNET/O=Masaryk University/CN=Milos Mulac',
     '1')
   ....
  \end{alltt}
 \item \emph{Check content of IS database}
 You can look whether the insert from previous step was successful:
 \begin{alltt}
  mysql -u jpis -e "select * from
    attr_52942b8c70bab8491ab5d3b9713d79f5;" jpis1
 \end{alltt}
  should return:
 \begin{alltt}
| jobid                            | value
| full_value                                      | origin |
+----------------------------------+-----------------------------------+
| 76698aabbf5d60dfa5b42c279e1f0e8c | S:/O=CESNET/O=Masaryk University/CN=Milos
Mulac 
| S:/O=CESNET/O=Masaryk University/CN=Milos Mulac |      1 |
 \end{alltt}
\end{enumerate}
\result{} Expected database INSERTs in the JP-IS (last two steps).

\subsection{Multiple feeds at time}
TODO

\subsection{Advanced feed features (to be implemented)}
- remove (not implemented in PS yet)
- splitted info about one job (check that the PS doesn't duplicate
  attribute values) - probably covered in 3.2


\subsection{PS-IS AuthZ}
TODO, if any

\section{IS queries}
\todo{Import from org.glite.jp.index/doc/README file}


%TBD: insert job sets via JP-IS interaction or directly?
%        - better to populate database directly, independent on previous chain
%
%All basic tests:
%- clear IS database
%- insert prepared job set
%- ask queries and check answers
%- clear database
%
%TBD: Is one job set enough?
%        - better to have one complete set
%

A majority of test from this chapter is automated by shell
script. The script is located in \texttt{org.glite.jp.index} module
under \texttt{example/query-tests} directory and called \texttt{run-test.sh}.
It is available as a part of JP index server RPM package.

\begin{hints}
The testing shell script is highly configurable via
environmental varibles.  Please, run the script (run-test.sh) with
'-?' option to get list of all variables and their meaning, if you are
not satisfied with default setting.
\end{hints}

\subsection{Simple query}
This test starts new index server instance, creates testing DB
and populate it with prepared data sample. Then simple query is given
to server, answer is checked with supposed return output and
cleanup is done.


\how\ Run \texttt{run-test.sh}

\begin{hints} 
The query is in file test/simple\_query.in and has following
  form: (status=Ready)
\end{hints}

\subsection{Complex query test}
This is similar to simple query test, only tested query is more complicated.

\how\ Run \texttt{run-test.sh}

\begin{hints}
The query is in file test/complex\_query.in and has followhing
  form: (status=Done OR status=READY) AND (user!=God)
\end{hints}

\subsection{Feed \& query test}
This test starts testing index server, feeds it by
mimicing bahaviour of primary storage server by sending data
via soap call, and then asks the index server using a complex
query. After that it checks the responce and does cleanup.

More precise description of steps:
\begin{enumerate}
 \item Simulation of response from a primary storage, making appropriate
   changes in JP-IS database (inserts feedid).
 \item Invocation of updateJobs wsdl call, normally invoked by JP-PS, and
   sending this way some data to the JP-IS which stores them in its database.
 \item Invocation of queryJobs wsdl call, normally called by user
   program, obtaining previously inserted data. Test query used here has form
   (status=Done OR status=Ready) AND (user!=God).
\end{enumerate}

\how\ Run \texttt{run-test.sh}

\subsection{AuthZ checks}
This test verifies that qeury responses are properly restricted by
authorization checks. Currently only implicit ACLs are implemented
inside JP-IS server, so explicit ACLs and its evaluation is to be implemented.

There are 3 scenarios to be verified:
\begin{itemize}
 \item Authorization (checking ownership) is swithed off (IS with -n
   option). This scenario is tested by simple query test described above.
 \item Only user jobs are returned and jobs not owned by the user posing
   the query are not covered by the query response. This scenario is
   covered by Feed \& query test described above.
 \item Check that queries to jobs not owned by the IS user are
   returning empty response. The same behaviour as simple query test
   described above but with user credential not matching job
   owner. This test is implemented by \texttt{run-test.sh} under AuthZ
   check part.
\end{itemize}

\subsection{Another supposed tests not implemented yet}

\begin{itemize}
 \item Check "origin" behaviour -- queries with origin tag
 \item IS CLI tests -- use prepared config files and command line parameters
  and check expected QueryJobs contents
\end{itemize}


\section{IS standalone advanced features}
\todo{To be implemented}

\subsection{Server startup}

\subsubsection{Reboot persistency / configuration vs. database content}
    situations handling
- prepared config files
- checking behaviour (how?) after reboot with different config file

\subsubsection{Registration of PS feeds}
! already covered by 3
- prepared config files
- checking appropriate FeedIndex calls

\subsection{Admin interface}
\todo{Admin interface not implemented yet}

\subsection{Type plugin}
\todo{type plugin tests -- to be designed, future type plugin implementation}

\section{Deployment}
\todo{tests on JP deployment process}
\todo{TBD}



\end{document}
